// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. USER MANAGEMENT (Roles for Maker-Checker)
// ==========================================
model User {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  password         String
  name             String
  role             String    @default("MAKER") // MAKER, CHECKER, ADMIN
  createdAt        DateTime  @default(now())

  // Relations
  createdVouchers  Voucher[] @relation("CreatedBy")
  verifiedVouchers Voucher[] @relation("VerifiedBy")
  
  // ✅ FEATURE 5: Audit Tracking for BOMs
  createdBoms      BOM[]     @relation("BOMMaker")
}

// ==========================================
// 2. COMPANY DATA
// ==========================================
model Company {
  id                Int               @id @default(autoincrement())
  name              String
  address           String?           @db.Text
  state             String?
  pincode           String?
  email             String?
  gstin             String?
  
  // Settings
  currencySymbol    String            @default("₹")
  financialYearFrom DateTime
  booksBeginFrom    DateTime

  // Relations
  groups           Group[]
  ledgers          Ledger[]
  vouchers         Voucher[]
  units            Unit[]
  stockGroups      StockGroup[]
  stockItems       StockItem[]
  sequences        VoucherSequence[]
  boms             BOM[]             
  
  createdAt        DateTime          @default(now())
}

// ==========================================
// 3. AUTO-NUMBERING
// ==========================================
model VoucherSequence {
  id          Int     @id @default(autoincrement())
  companyId   Int
  company     Company @relation(fields: [companyId], references: [id])
  voucherType String  // SALES, PAYMENT, RECEIPT...
  lastNo      Int     @default(0)

  @@unique([companyId, voucherType])
}

// ==========================================
// 4. ACCOUNTING MASTERS (Groups & Ledgers)
// ==========================================
model Group {
  id        Int     @id @default(autoincrement())
  name      String
  nature    String? // ASSET, LIABILITY, INCOME, EXPENSE
  
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])
  
  ledgers   Ledger[]
  
  // Self-Relation (Groups inside Groups)
  parentId  Int?
  parent    Group?  @relation("GroupHierarchy", fields: [parentId], references: [id])
  children  Group[] @relation("GroupHierarchy")

  @@unique([name, companyId])
}

model Ledger {
  id              Int            @id @default(autoincrement())
  name            String
  address         String?        @db.Text
  openingBalance  Float          @default(0.0)
  
  groupId         Int?           
  group           Group?         @relation(fields: [groupId], references: [id])
  
  companyId       Int
  company         Company        @relation(fields: [companyId], references: [id])
  
  // Relations
  entries         VoucherEntry[]
  vouchersAsParty Voucher[]      @relation("PartyLedger")

  // Tally Specifics
  tallyName       String?        
  state           String?        
  gstin           String?        

  @@unique([name, companyId])
}

// ==========================================
// 5. INVENTORY MASTERS
// ==========================================
model Unit {
  id        Int         @id @default(autoincrement())
  name      String
  symbol    String
  companyId Int
  company   Company     @relation(fields: [companyId], references: [id])
  items     StockItem[]
  
  @@unique([symbol, companyId])
}

model StockGroup {
  id        Int          @id @default(autoincrement())
  name      String
  companyId Int
  company   Company      @relation(fields: [companyId], references: [id])
  items     StockItem[]
  
  parentId  Int?
  parent    StockGroup?  @relation("StockHierarchy", fields: [parentId], references: [id])
  children  StockGroup[] @relation("StockHierarchy")
  
  @@unique([name, companyId])
}

model StockItem {
  id               Int              @id @default(autoincrement())
  name             String
  partNumber       String?
  
  // Balance Fields
  openingQty       Float            @default(0)
  openingValue     Float            @default(0)
  quantity         Float            @default(0) // Current Stock level
  
  // ✅ FEATURE 3: REORDER ALERTS
  minStock         Float            @default(0) 

  groupId          Int?
  group            StockGroup?      @relation(fields: [groupId], references: [id])
  
  unitId           Int?
  unit             Unit?            @relation(fields: [unitId], references: [id])
  
  companyId        Int
  company          Company          @relation(fields: [companyId], references: [id])
  
  inventoryEntries InventoryEntry[]
  gstRate          Float            @default(0) 

  // ✅ FEATURE 2: BILL OF MATERIALS (BOM) RELATIONS
  producedBy       BOM[]            @relation("FinishedGood")
  usedInBoms       BOMItem[]        @relation("BOMComponent")
  
  @@unique([name, companyId])
}

// ✅ NEW MODEL: BILL OF MATERIALS (BOM)
model BOM {
  id             Int       @id @default(autoincrement())
  name           String    
  
  finishedGoodId Int
  finishedGood   StockItem @relation("FinishedGood", fields: [finishedGoodId], references: [id])
  targetQty      Float     @default(1.0) 
  
  components     BOMItem[]

  companyId      Int
  company        Company   @relation(fields: [companyId], references: [id])

  // ✅ FEATURE 5: AUDIT TRAIL for Master Data
  createdById    Int
  createdBy      User      @relation("BOMMaker", fields: [createdById], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model BOMItem {
  id          Int       @id @default(autoincrement())
  bomId       Int
  bom         BOM       @relation(fields: [bomId], references: [id], onDelete: Cascade)
  
  stockItemId Int
  stockItem   StockItem @relation("BOMComponent", fields: [stockItemId], references: [id])
  quantity    Float     
}

// ==========================================
// 6. VOUCHER (Transactions)
// ==========================================
model Voucher {
  id              Int      @id @default(autoincrement())
  
  voucherNo       String   
  transactionCode String?  @unique 
  
  type            String   // SALES, RECEIPT, PAYMENT, STOCK_JOURNAL...
  date            DateTime 
  narration       String?  @db.Text
  
  reference       String?  
  partyName       String?  
  
  partyLedgerId   Int?     
  partyLedger     Ledger?  @relation("PartyLedger", fields: [partyLedgerId], references: [id])

  partyGstin      String?  
  placeOfSupply   String?  
  totalAmount     Float?    

  // ✅ FEATURE 5: ATTACHMENTS (Unique field)
  attachmentUrl   String?  @db.Text 

  companyId       Int
  company         Company  @relation(fields: [companyId], references: [id])
  
  status          String   @default("PENDING") // PENDING, APPROVED
  
  createdById     Int      
  createdBy       User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  verifiedById    Int?
  verifiedBy      User?    @relation("VerifiedBy", fields: [verifiedById], references: [id])

  entries         VoucherEntry[]   
  inventory       InventoryEntry[] 
  
  // ✅ FEATURE 5: AUDIT LOGS
  auditLogs       AuditLog[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([companyId, voucherNo, type]) 
}

// ✅ NEW MODEL: AUDIT LOG (Feature 5)
model AuditLog {
  id          Int      @id @default(autoincrement())
  voucherId   Int
  voucher     Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  userId      Int
  userName    String   
  action      String   // "CREATED", "EDITED", "VERIFIED", "REJECTED"
  details     String?  @db.Text 
  createdAt   DateTime @default(now())
}

model VoucherEntry {
  id              Int      @id @default(autoincrement())
  ledgerName      String?   
  ledgerId        Int?     
  ledger          Ledger?  @relation(fields: [ledgerId], references: [id]) 
  
  amount          Float    // Positive = Debit, Negative = Credit
  
  voucherId       Int
  voucher         Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

model InventoryEntry {
  id          Int       @id @default(autoincrement())
  voucherId   Int
  stockItemId Int
  itemName    String
  quantity    Float
  rate        Float
  amount      Float
  unit        String?
  
  isProduction Boolean   @default(false) 

  voucher     Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  stockItem   StockItem @relation(fields: [stockItemId], references: [id])
}