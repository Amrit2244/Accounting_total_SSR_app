// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. USER MANAGEMENT (Roles for Maker-Checker)
// ==========================================
model User {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  password         String
  name             String
  role             String    @default("MAKER") // MAKER, CHECKER, ADMIN
  createdAt        DateTime  @default(now())

  // Relations
  createdVouchers  Voucher[] @relation("CreatedBy")
  verifiedVouchers Voucher[] @relation("VerifiedBy")
}

// ==========================================
// 2. COMPANY DATA
// ==========================================
model Company {
  id               Int       @id @default(autoincrement())
  name             String
  address          String?   @db.Text
  state            String?
  pincode          String?
  email            String?
  gstin            String?
  
  // Settings
  currencySymbol   String    @default("â‚¹")
  financialYearFrom DateTime
  booksBeginFrom   DateTime

  // Relations
  groups           Group[]
  ledgers          Ledger[]
  vouchers         Voucher[]
  units            Unit[]
  stockGroups      StockGroup[]
  stockItems       StockItem[]
  sequences        VoucherSequence[]
  
  createdAt        DateTime  @default(now())
}

// ==========================================
// 3. AUTO-NUMBERING
// ==========================================
model VoucherSequence {
  id          Int     @id @default(autoincrement())
  companyId   Int
  company     Company @relation(fields: [companyId], references: [id])
  voucherType String  // SALES, PAYMENT, RECEIPT...
  lastNo      Int     @default(0)

  @@unique([companyId, voucherType])
}

// ==========================================
// 4. ACCOUNTING MASTERS (Groups & Ledgers)
// ==========================================
model Group {
  id        Int     @id @default(autoincrement())
  name      String
  nature    String? // ASSET, LIABILITY, INCOME, EXPENSE (Optional for Tally Import)
  
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])
  
  ledgers   Ledger[]
  
  // Self-Relation (Groups inside Groups)
  parentId  Int?
  parent    Group?  @relation("GroupHierarchy", fields: [parentId], references: [id])
  children  Group[] @relation("GroupHierarchy")

  @@unique([name, companyId])
}

model Ledger {
  id              Int      @id @default(autoincrement())
  name            String
  address         String?   @db.Text
  openingBalance  Float    @default(0.0)
  
  groupId         Int?     // Optional initially, but recommended
  group           Group?   @relation(fields: [groupId], references: [id])
  
  companyId       Int
  company         Company  @relation(fields: [companyId], references: [id])
  
  // Relations
  entries         VoucherEntry[]
  vouchersAsParty Voucher[] @relation("PartyLedger") // Link for 'partyLedgerId' in Voucher

  // Tally Specifics
  tallyName       String?        
  state           String?        
  gstin           String?        

  @@unique([name, companyId])
}

// ==========================================
// 5. INVENTORY MASTERS
// ==========================================
model Unit {
  id        Int         @id @default(autoincrement())
  name      String
  symbol    String
  companyId Int
  company   Company     @relation(fields: [companyId], references: [id])
  items     StockItem[]
  
  @@unique([symbol, companyId])
}

model StockGroup {
  id        Int         @id @default(autoincrement())
  name      String
  companyId Int
  company   Company     @relation(fields: [companyId], references: [id])
  items     StockItem[]
  
  parentId  Int?
  parent    StockGroup? @relation("StockHierarchy", fields: [parentId], references: [id])
  children  StockGroup[] @relation("StockHierarchy")
  
  @@unique([name, companyId])
}

model StockItem {
  id               Int              @id @default(autoincrement())
  name             String
  partNumber       String?
  
  groupId          Int?
  group            StockGroup?      @relation(fields: [groupId], references: [id])
  
  unitId           Int?
  unit             Unit?            @relation(fields: [unitId], references: [id])
  
  companyId        Int
  company          Company          @relation(fields: [companyId], references: [id])
  
  inventoryEntries InventoryEntry[]
  gstRate          Float            @default(0) // 0, 5, 12, 18, 28
  
  @@unique([name, companyId])
}

// ==========================================
// 6. VOUCHER (Transactions)
// ==========================================
model Voucher {
  id              Int      @id @default(autoincrement())
  
  // --- Existing Identity Fields ---
  voucherNo       String   
  transactionCode String?  @unique // 5 Digit Code
  
  // --- Tally/Voucher Fields ---
  type            String   // SALES, RECEIPT, PAYMENT...
  date            DateTime 
  narration       String?
  
  // --- New Fields for Tally Import ---
  reference       String?  // For Tally Reference (e.g. "5689")
  partyName       String?  // For Tally Party Name
  
  partyLedgerId   Int?     // Link to Ledger Table
  partyLedger     Ledger?  @relation("PartyLedger", fields: [partyLedgerId], references: [id])

  partyGstin      String?  // Optional Taxation Field
  placeOfSupply   String?  // Optional Taxation Field
  totalAmount     Float?    // Total Voucher Value (Required for Reports)

  // --- Company Relation ---
  companyId       Int
  company         Company  @relation(fields: [companyId], references: [id])
  
  // --- Maker Checker Workflow ---
  status          String   @default("PENDING") // PENDING, APPROVED
  
  createdById     Int      // Kept as Int (Required)
  createdBy       User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  verifiedById    Int?
  verifiedBy      User?    @relation("VerifiedBy", fields: [verifiedById], references: [id])

  // --- Relations ---
  entries         VoucherEntry[]   // Accounting Dr/Cr
  inventory       InventoryEntry[] // Item Details
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Unique constraint to prevent duplicate Tally imports
  @@unique([companyId, voucherNo, type]) 
}

model VoucherEntry {
  id              Int      @id @default(autoincrement())
  
  ledgerName      String?   
  ledgerId        Int?     // Linked Ledger ID
  ledger          Ledger?  @relation(fields: [ledgerId], references: [id]) // FIXED: Added Relation
  
  amount          Float    // Positive = Debit, Negative = Credit
  
  voucherId       Int
  voucher         Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------
// INVENTORY ENTRIES (Stock Items)
// ---------------------------------------------
model InventoryEntry {
  id              Int        @id @default(autoincrement())
  
  itemName        String   
  stockItemId     Int?       // Linked StockItem ID
  stockItem       StockItem? @relation(fields: [stockItemId], references: [id]) // FIXED: Added Relation
  
  quantity        Float    
  unit            String?  
  rate            Float    
  amount          Float    
  
  voucherId       Int
  voucher         Voucher    @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}